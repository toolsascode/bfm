# Standalone Production Docker Compose for BfM Stack
# This file orchestrates the standalone production container that includes:
# - BfM API Server (HTTP on 7070, gRPC on 9090)
# - BfM Worker (conditional, when BFM_QUEUE_ENABLED=true)
# - BfM CLI (available in container)
# - FfM Frontend (served via HAProxy on 4040)
# - HAProxy (reverse proxy on port 4040)
#
# Usage:
#   docker compose -f deploy/docker-compose.standalone.yml up -d          # Start standalone service
#   docker compose -f deploy/docker-compose.standalone.yml down            # Stop service
#   docker compose -f deploy/docker-compose.standalone.yml logs -f         # View logs
#   docker compose -f deploy/docker-compose.standalone.yml ps              # List running services

x-default-logging: &logging
  logging:
    driver: "json-file"
    options:
      max-size: "5m"
      max-file: "2"
      tag: "{{.Name}}"

services:
  # PostgreSQL for state tracking
  postgres:
    <<: *logging
    image: postgres:16-alpine
    container_name: bfm-postgres
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${BFM_STATE_DB_PASSWORD:-postgres}
      - POSTGRES_DB=migration_state
      - POSTGRES_MULTIPLE_DATABASES=dashcloud
    volumes:
      - bfm-postgres-data:/var/lib/postgresql/data
    networks:
      - bfm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # BfM Standalone Production Container
  bfm-standalone:
    <<: *logging
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: bfm-standalone
    ports:
      - "4040:4040"  # HAProxy (frontend and API proxy)
      - "7070:7070"  # BfM HTTP API (direct access)
      - "9090:9090"  # BfM gRPC API (direct access)
    environment:
      # Server Configuration
      - BFM_HTTP_PORT=7070
      - BFM_GRPC_PORT=9090
      - BFM_API_TOKEN=${BFM_API_TOKEN:-SFXfytYJr3RfrjPMgEkhTEukOGpjhtLEmmJFYv+7GHQ=}
      - BFM_SFM_PATH=${BFM_SFM_PATH:-/app/sfm}

      # State Database Configuration
      - BFM_STATE_BACKEND=postgresql
      - BFM_STATE_DB_HOST=postgres
      - BFM_STATE_DB_PORT=5432
      - BFM_STATE_DB_USERNAME=${BFM_STATE_DB_USERNAME:-postgres}
      - BFM_STATE_DB_PASSWORD=${BFM_STATE_DB_PASSWORD:-postgres}
      - BFM_STATE_DB_NAME=${BFM_STATE_DB_NAME:-migration_state}
      - BFM_STATE_SCHEMA=${BFM_STATE_SCHEMA:-public}

      # Core Backend Connection (matches SFM example: core connection)
      - CORE_BACKEND=postgresql
      - CORE_DB_HOST=${CORE_DB_HOST:-postgres}
      - CORE_DB_PORT=5432
      - CORE_DB_USERNAME=${CORE_DB_USERNAME:-postgres}
      - CORE_DB_PASSWORD=${CORE_DB_PASSWORD:-postgres}
      - CORE_DB_NAME=${CORE_DB_NAME:-migration_state}
      - CORE_SCHEMA=core

      # Logs Backend Connection (matches SFM example: logs connection for GreptimeDB)
      - LOGS_BACKEND=greptimedb
      - LOGS_DB_HOST=${LOGS_DB_HOST:-}
      - LOGS_DB_PORT=${LOGS_DB_PORT:-4001}
      - LOGS_DB_USERNAME=${LOGS_DB_USERNAME:-}
      - LOGS_DB_PASSWORD=${LOGS_DB_PASSWORD:-}
      - LOGS_DB_NAME=${LOGS_DB_NAME:-}

      # Metadata Backend Connection (matches SFM example: metadata connection for Etcd)
      - METADATA_BACKEND=etcd
      - METADATA_DB_HOST=${METADATA_DB_HOST:-}
      - METADATA_DB_PORT=${METADATA_DB_PORT:-2379}
      - METADATA_DB_USERNAME=${METADATA_DB_USERNAME:-}
      - METADATA_DB_PASSWORD=${METADATA_DB_PASSWORD:-}
      - METADATA_ENDPOINTS=${METADATA_ENDPOINTS:-}
      - METADATA_PREFIX=/bfm/metadata/

      # Queue Configuration (disabled by default)
      - BFM_QUEUE_ENABLED=${BFM_QUEUE_ENABLED:-false}
      - BFM_QUEUE_TYPE=${BFM_QUEUE_TYPE:-kafka}

      # Frontend Configuration (for FfM)
      - BFM_FRONTEND_API_URL=${BFM_FRONTEND_API_URL:-/api}
      - BFM_FRONTEND_AUTH_ENABLED=${BFM_FRONTEND_AUTH_ENABLED:-true}
      - BFM_FRONTEND_AUTH_USERNAME=${BFM_FRONTEND_AUTH_USERNAME:-admin}
      - BFM_FRONTEND_AUTH_PASSWORD=${BFM_FRONTEND_AUTH_PASSWORD:-admin123}
    volumes:
      # Mount SFM examples to /app/sfm (for migration scripts)
      - ../examples/sfm:/app/sfm:rw
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - bfm-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  bfm-network:
    driver: bridge
    name: bfm-network

volumes:
  bfm-postgres-data:
    name: bfm-postgres-data
